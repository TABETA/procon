---
applyTo: "ahc048/A/main.cpp"
---

# AHC048 A

## 指示

後述の **問題** をC++によるプログラミングによって解け。
問題を解くに当たって、以下の知識を活用せよ。

* ヒューリスティックアルゴリズム
* C++
* 競技プログラミング

## 問題

K 種類のチューブ絵の具を所持しており、i 番目のチューブの色は  
**(Cᵢₒwₙ, Mᵢₒwₙ, Yᵢₒwₙ)** である。  

各チューブから絵の具を 1 グラム使うごとに、コスト **D** がかかる。  
これらのチューブを用いて、**H 種類の色**を順番に 1 グラムずつ作成し、画伯に渡したい。  

i 番目に作るべき色は  
**(Cᵢₜₐᵣgₑₜ, Mᵢₜₐᵣgₑₜ, Yᵢₜₐᵣgₑₜ)** である。  
作成の順番は固定で、変更することはできない。

---

絵の具を混ぜるパレットは **N×N** の格子状のマス目で構成されている。  
左上のマスの座標を **(0,0)** とし、  
下方向に i、右方向に j マス進んだ位置の座標を **(i,j)** とする。

各マスは、上下左右の隣接マスとの間に出し入れ可能な仕切りを備えている。  
これらの仕切りの初期状態は、自由に設定してよい。

隣接するマスの間の仕切りが下がっている場合、それらのマスは**連結**であると呼ぶ。  
連結なマス同士をたどって到達可能なマスの集合を**ウェル**と定義する。  

仕切りの出し入れによって、複数のウェルを結合したり、1つのウェルを分割して複数にすることができる。

各ウェルには高々1色の絵の具しか入れられず、  
k マスからなるウェルには最大で **k グラム**の絵の具を入れることができる。  
初期状態ではどのウェルにも絵の具は入っていない。

---

あなたは以下の操作を、最大で **T ターン**まで行うことができる：

1. **チューブから絵の具を出す**  
   任意のマスとチューブを 1 つずつ選び、そのマスが属するウェルにチューブから 1 グラムの絵の具を出す。  
   * ウェルの残り容量を **w** とすると、実際に混ざるのは `min(w,1)` グラム  
   * 残りの `1−min(w,1)` グラムは混ざらずに即座に**廃棄**される。

2. **絵の具を取り出して画伯に渡す**  
   任意のマスを選び、そのマスの属するウェルから 1 グラムの絵の具を取り出す。  
   * そのウェルに**1 グラム未満**しか入っていない場合は選べない。

3. **絵の具を廃棄する**  
   任意のマスを選び、そのマスの属するウェルから 1 グラムの絵の具を廃棄する。  
   * 1 グラムに満たない場合はすべて廃棄される。

4. **仕切りを出し入れする**  
   隣接する 2 マス **s, t** を選び、仕切りを出し入れする。  
   * **仕切りを引っ込めた場合**：2 つのウェルが合併 → 絵の具は混ざって 1 色になる  
   * **仕切りを出した場合**：1 つのウェルが 2 つに分割 → 絵の具も**容量に比例**して分割される

   絵の具量が **v**、  
   分割後の s 側容量が **vₛ**、t 側容量が **vₜ** のとき：

   ```text
   s 側に残る絵の具量：v × (vₛ / (vₛ + vₜ))
   t 側に残る絵の具量：v × (vₜ / (vₛ + vₜ))
   ```

> 操作 2 は、ちょうど **H 回**行わなければならない。  
> H 回に満たない、または超過した場合は不正と見なされる。

---

### 計算誤差について

絵の具の量は分数値になるため、操作 2 の「1 グラム以上」の判定は厳密には難しい。  
ジャッジプログラムでは、絵の具量を **倍精度浮動小数（double）** で管理し、以下のように判定する。

* **操作可否の判定**
  * `v < 1 − 10⁻⁶` の場合：「1 グラム未満」と見なす → 操作 2 は実行不可
  * `v ≥ 1 − 10⁻⁶` の場合：「1 グラム以上」と見なす → 操作 2 実行可

* **取り出し量の決定**
  * `v ≥ 1` の場合：ちょうど 1 グラムを取り出す
  * `1 − 10⁻⁶ ≤ v < 1` の場合：ウェル内の絵の具をすべて取り出す

### 得点計算について

i 番目に画伯に渡した絵の具の色を  
**(Cᵢₘₐdₑ, Mᵢₘₐdₑ, Yᵢₘₐdₑ)** としたとき、誤差 **E** は以下で定義される：

```text
E = Σ ( (Cᵢₜₐᵣgₑₜ − Cᵢₘₐdₑ)² + (Mᵢₜₐᵣgₑₜ − Mᵢₘₐdₑ)² + (Yᵢₜₐᵣgₑₜ − Yᵢₘₐdₑ)² )
    i = 0 to H-1
```

---

操作 1 を行った回数を **V** とすると、  
以下の**絶対スコア**が得られる：

```text
絶対スコア = 1 + D × (V − H) + round(10⁴ × E)
```

絶対スコアは**小さいほど良い**。

---

各テストケースごとに、次の**相対評価スコア**が与えられる：

```text
相対評価スコア = round(10⁹ × (自身の絶対スコア ÷ 全参加者中の最小絶対スコア))
```

その和が提出全体の得点となる。

---

### 最終順位について

* 最終順位はコンテスト終了後に実施される「**システムテスト**」に基づく得点で決まる。
* 暫定テストおよびシステムテストでは、以下の場合にそのテストケースの得点は **0 点** となる：
  * 不正な出力
  * 制限時間超過

> この場合、該当テストケースは「全参加者中の最小絶対スコア」の計算対象からも除外される。

なお、**システムテストは最後に得られた AC（Accepted）以外の提出結果に対しては行われない**ため、  
**最終的に提出する解答を慎重に選ぶこと**。

### 入力

入力は以下の形式で標準入力から与えられる：

```text
N K H T D
C₀ₒwₙ M₀ₒwₙ Y₀ₒwₙ
⋮
Cₖ₋₁ₒwₙ Mₖ₋₁ₒwₙ Yₖ₋₁ₒwₙ
C₀ₜₐᵣgₑₜ M₀ₜₐᵣgₑₜ Y₀ₜₐᵣgₑₜ
⋮
Cₕ₋₁ₜₐᵣgₑₜ Mₕ₋₁ₜₐᵣgₑₜ Yₕ₋₁ₜₐᵣgₑₜ
```

#### 制約

* パレットサイズ **N** は全テストケースで `N = 20`
* チューブの種類数 **K** は `4 ≤ K ≤ 20`
* 作成すべき色数 **H** は全テストケースで `H = 1000`
* 操作可能な最大ターン数 **T** は `4000 ≤ T ≤ 64000`
* 絵の具1gを出すコスト **D** は `10 ≤ D ≤ 10000`

---

### 出力

#### 初期状態における仕切りの配置：

```text
v₀,₀ ⋯ v₀,ₙ₋₂
⋮
vₙ₋₁,₀ ⋯ vₙ₋₁,ₙ₋₂
h₀,₀ ⋯ h₀,ₙ₋₁
⋮
hₙ₋₂,₀ ⋯ hₙ₋₂,ₙ₋₁
```

* `vᵢ,ⱼ` はマス (i, j) と (i, j+1) 間の縦の仕切り（0: 下がっている, 1: 出ている）
* `hᵢ,ⱼ` はマス (i, j) と (i+1, j) 間の横の仕切り（0: 下がっている, 1: 出ている）

---

#### 最大 **T** 行の操作を出力：

各行は以下いずれかの形式：

* `1 i j k` : マス (i, j) の属するウェルにチューブ k から 1g の絵の具を追加（0 ≤ k < K）
* `2 i j`   : マス (i, j) の属するウェルから 1g を画伯に渡す
* `3 i j`   : マス (i, j) の属するウェルから 1g を廃棄する
* `4 i₁ j₁ i₂ j₂` : マス (i₁, j₁) と (i₂, j₂) 間の仕切りを出し入れ
